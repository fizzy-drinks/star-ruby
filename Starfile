#!/usr/bin/env ruby

require "securerandom"
require "./lib/database_adapter/sqlite"

app unhype

db Star::DatabaseAdapter::Sqlite

model(tasklists) {
  id { string { SecureRandom.uuid } }
  name { required string }
}

model(tasks) {
  id { string { SecureRandom.uuid } }
  title { required string }
  tasklist_id { required string }
  created_at { date { DateTime.now } }
  date_due { date { DateTime.now } }
  closed_at { date }
}

router {
  tasklists {
    get {
      use {
        query {
          name Object
        }
      }

      app.models.tasklists.where(name:).to_json
    }

    get("{id}") {
      app.models.tasklists.find(id:).to_json
    }

    post {
      use {
        body {
          name String
        }
      }

      app.models.tasklists.create(name:).to_json
    }

    patch("{id}") {
      use {
        body {
          name String
        }
      }

      app.models.tasklists.update(match: {id:}, update: {name:})
    }

    delete("{id}") {
      app.models.tasklists.delete(id:)
    }

    scope("{tasklist_id}/tasks") {
      get {
        app.models.tasks.where(tasklist_id:).to_json
      }

      get("{id}") {
        app.models.tasks.find(tasklist_id:, id:).to_json
      }

      post {
        use {
          body {
            title String
            date_due Object
          }
        }

        app.models.tasks.create(tasklist_id:, title:, date_due:).to_json
      }

      patch("{id}") {
        use {
          body {
            title Object
            date_due Object
            closed_at Object
          }
        }

        update = {title:, date_due:, closed_at:}.filter { |k, v| !v.nil? }.to_h
        app.models.tasks.update(match: {tasklist_id:, id:}, update:).to_json
      }

      delete("{id}") {
        app.models.tasks.delete(tasklist_id:, id:).to_json
      }
    }
  }
}
